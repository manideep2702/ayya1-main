(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6648,7370],{14861:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>c});var r=a(95155),n=a(12115),i=a(52828),s=a(96648),l=a(33946),o=a(20063);function c(){let[e,t]=n.useState(null),[a,c]=n.useState(!1),[d,u]=n.useState(""),[m,h]=n.useState(null),[p,f]=n.useState(null),[v,g]=n.useState(!1),x=n.useRef(null),b=n.useRef(null),y=n.useRef(null),w=n.useRef(null),{show:N}=(0,l.M)(),j=(0,o.useRouter)();async function k(){let e=globalThis.BarcodeDetector;if(e)try{var t;let a=await (null==(t=e.getSupportedFormats)?void 0:t.call(e));if(Array.isArray(a)&&(a.includes("qr_code")||a.includes("qr"))){w.current=new e({formats:["qr_code"]});return}}catch(e){}try{globalThis.QrScanner||await new Promise((e,t)=>{let a=document.createElement("script");a.src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.min.js",a.async=!0,a.onload=()=>e(),a.onerror=()=>t(Error("Failed to load QrScanner")),document.head.appendChild(a)});let e=globalThis.QrScanner;if(e){e.WORKER_PATH="https://unpkg.com/qr-scanner@1.4.2/qr-scanner-worker.min.js",w.current={async detect(t){try{let a=await e.scanImage(t,{returnDetailedScanResult:!0});if(a){let e="string"==typeof a?a:a.data||a.text||"";return e?[{rawValue:e}]:[]}return[]}catch(e){return[]}}},N({title:"Using fallback scanner",description:"Native QR detector not available; using fallback decoder.",variant:"info"});return}}catch(e){}w.current=null}async function C(){try{var t,a;let r=null==e||null==(t=e.getVideoTracks)?void 0:t.call(e)[0],n=null==r||null==(a=r.getCapabilities)?void 0:a.call(r);if(!r||!n||!("torch"in n))return void N({title:"Torch not available",description:"Your device does not expose a torch control.",variant:"info"});let i=!v;await r.applyConstraints({advanced:[{torch:i}]}),g(i)}catch(e){N({title:"Torch error",description:(null==e?void 0:e.message)||"Could not toggle torch",variant:"error"})}}async function S(e){try{if(!w.current)return void N({title:"Not Supported",description:"QR detection not supported in this browser. Use Manual Code.",variant:"error"});let a=null;try{let t=await createImageBitmap(e);a=await w.current.detect(t)}catch(e){a=null}if(!a||0===a.length){let t=URL.createObjectURL(e);await new Promise(e=>{let r=new Image;r.onload=async()=>{try{let e=document.createElement("canvas");e.width=r.naturalWidth,e.height=r.naturalHeight;let t=e.getContext("2d");t&&t.drawImage(r,0,0);let n=await w.current.detect(e);a=Array.isArray(n)?n:[]}finally{URL.revokeObjectURL(t),e()}},r.onerror=()=>{URL.revokeObjectURL(t),e()},r.src=t})}if(a&&a.length>0){var t;let e=(null==(t=a[0])?void 0:t.rawValue)||"";if(e&&!m){u(e),await A(e);return}}N({title:"No QR Found",description:"Could not detect a QR in the selected image.",variant:"warning"})}catch(e){N({title:"Upload Error",description:(null==e?void 0:e.message)||"Could not process image",variant:"error"})}}async function A(e){try{var t;let a=function(e){try{let t=e.trim();if(/^ANNA:/i.test(t)){let e=t.split(":");if(e.length>=3)return{id:e[1],token:e[2]}}if(/^https?:\/\//i.test(t)){let e=new URL(t),a=e.searchParams.get("b")||e.searchParams.get("id")||"",r=e.searchParams.get("t")||e.searchParams.get("token")||"";if(a&&r)return{id:a,token:r}}if(t.startsWith("{")&&t.endsWith("}")){let e=JSON.parse(t);if(("anna"===e.t||"anna"===e.type)&&e.id&&e.token)return{id:String(e.id),token:String(e.token)}}}catch(e){}return null}(e);if(!a)return void N({title:"Invalid Code",description:"QR not recognized for Annadanam",variant:"error"});let r=(0,s.getSupabaseBrowserClient)(),{data:n}=await r.auth.getSession();if(!(null==n?void 0:n.session)){N({title:"Not Logged In",description:"Please login as admin and retry.",variant:"error"}),j.push("/admin");return}c(!1);let{data:i,error:l}=await r.rpc("lookup_annadanam_pass",{token:a.token});if(l){N({title:"Lookup Failed",description:l.message||"Could not read pass",variant:"error"}),c(!0);return}let o=Array.isArray(i)?null!=(t=i[0])?t:null:null!=i?i:null;if(!o){N({title:"Lookup Failed",description:"Pass not found",variant:"error"}),c(!0);return}f(o),h(a)}catch(e){N({title:"Scan Error",description:(null==e?void 0:e.message)||"Unexpected error",variant:"error"})}}async function R(){if(m)try{var e;let t=(0,s.getSupabaseBrowserClient)(),{data:a}=await t.auth.getSession();if(!(null==a?void 0:a.session)){N({title:"Not Logged In",description:"Please login as admin and retry.",variant:"error"}),j.push("/admin");return}let{data:r,error:n}=await t.rpc("mark_annadanam_attended",{token:m.token});if(n)return void N({title:"Confirm Failed",description:n.message||"Could not mark attendance",variant:"error"});let i=Array.isArray(r)?null!=(e=r[0])?e:null:null!=r?r:null;if(!i)return void N({title:"Confirm Failed",description:"No row returned",variant:"error"});N({title:"Attendance Marked",description:"".concat((null==i?void 0:i.name)||"Devotee"," • ").concat(null==i?void 0:i.date," • ").concat(null==i?void 0:i.session),variant:"success"}),h(null),f(null),c(!0)}catch(e){N({title:"Confirm Error",description:(null==e?void 0:e.message)||"Unexpected error",variant:"error"})}}return n.useEffect(()=>{let r=!1;return async function(){try{let e="undefined"!=typeof navigator&&!!navigator.mediaDevices&&"function"==typeof navigator.mediaDevices.getUserMedia;if(await k(),!e)return void N({title:"Camera not available",description:"Live camera requires HTTPS or a supported browser. You can still use the Manual Code or upload a photo of the QR below.",variant:"warning"});let n=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"},width:{ideal:1280},height:{ideal:720}}});if(r)return;t(n),c(!0),x.current&&(x.current.srcObject=n,await x.current.play().catch(()=>{}));let i=async()=>{if(!a||!x.current){y.current=requestAnimationFrame(i);return}let e=x.current,t=e.videoWidth||640,r=e.videoHeight||480;if(b.current){let a=b.current;a.width!==t&&(a.width=t),a.height!==r&&(a.height=r);let i=a.getContext("2d");if(i&&(i.drawImage(e,0,0,t,r),w.current))try{let e=[];try{if("function"==typeof createImageBitmap){let t=await createImageBitmap(a);e=await w.current.detect(t)}}catch(e){}if(!e||0===e.length)try{e=await w.current.detect(a)}catch(e){}if((!e||0===e.length)&&x.current)try{e=await w.current.detect(x.current)}catch(e){}if(Array.isArray(e)&&e.length>0){var n;let t=(null==(n=e[0])?void 0:n.rawValue)||"";t&&t!==d&&!m&&(u(t),await A(t))}}catch(e){}}y.current=requestAnimationFrame(i)};y.current=requestAnimationFrame(i)}catch(e){N({title:"Camera Error",description:(null==e?void 0:e.message)||"Could not access camera. Try using the Upload QR option below.",variant:"error"})}}(),()=>{r=!0,y.current&&cancelAnimationFrame(y.current),e&&e.getTracks().forEach(e=>e.stop())}},[]),(0,r.jsx)(i.A,{children:(0,r.jsx)("main",{className:"min-h-screen p-6 md:p-10",children:(0,r.jsxs)("div",{className:"mx-auto max-w-3xl space-y-4",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)("h1",{className:"text-2xl font-bold",children:"Annadanam QR Scanner"}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:function(){var e;let t=((null==(e=navigator)?void 0:e.userAgent)||"").toLowerCase(),a=t.includes("android"),r=t.includes("iphone")||t.includes("ipad")||t.includes("ipod");try{if(a){window.location.href="https://lens.google/";return}if(r){window.location.href="x-apple-codescanner://";return}}catch(e){}},className:"rounded border px-3 py-1.5",children:"Open Device Scanner"}),(0,r.jsx)("button",{onClick:C,className:"rounded border px-3 py-1.5",children:v?"Torch Off":"Torch On"}),(0,r.jsx)("button",{onClick:()=>j.push("/admin/annadanam"),className:"rounded border px-3 py-1.5",children:"Back"})]})]}),(0,r.jsx)("p",{className:"text-sm text-muted-foreground",children:"Scan the QR to load booking details, then confirm attendance."}),(0,r.jsx)("div",{className:"rounded-xl border overflow-hidden",children:(0,r.jsx)("video",{ref:x,className:"block w-full aspect-[4/3] bg-black",playsInline:!0,muted:!0})}),(0,r.jsx)("canvas",{ref:b,className:"hidden"}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("label",{className:"text-sm",children:"Upload QR (fallback)"}),(0,r.jsx)("input",{type:"file",accept:"image/*",capture:"environment",className:"block w-full text-sm",onChange:e=>{var t;let a=null==(t=e.target.files)?void 0:t[0];a&&S(a)}})]}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("label",{className:"text-sm",children:"Manual Code"}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("input",{type:"text",className:"w-full rounded border px-3 py-2 bg-background",placeholder:"ANNA:<id>:<token> or URL with ?b=...&t=...",value:d,onChange:e=>u(e.target.value)}),(0,r.jsx)("button",{className:"rounded border px-3 py-2",onClick:()=>A(d),children:"Submit"})]})]}),p&&(0,r.jsxs)("div",{className:"rounded-xl border bg-card/70 p-4 space-y-2",children:[(0,r.jsxs)("div",{className:"text-sm",children:["Name: ",(0,r.jsx)("strong",{children:p.name})]}),(0,r.jsxs)("div",{className:"text-sm",children:["Email: ",p.email]}),(0,r.jsxs)("div",{className:"text-sm",children:["Date: ",p.date]}),(0,r.jsxs)("div",{className:"text-sm",children:["Session: ",p.session]}),(0,r.jsxs)("div",{className:"text-sm",children:["Qty: ",p.qty]}),(0,r.jsxs)("div",{className:"text-sm",children:["Status: ",p.status]}),(0,r.jsxs)("div",{className:"flex gap-3 pt-2",children:[(0,r.jsx)("button",{className:"rounded bg-black text-white px-3 py-2",onClick:R,children:"Confirm Attendance"}),(0,r.jsx)("button",{className:"rounded border px-3 py-2",onClick:function(){h(null),f(null),c(!0)},children:"Cancel"})]})]})]})})})}},20063:(e,t,a)=>{"use strict";var r=a(47260);a.o(r,"usePathname")&&a.d(t,{usePathname:function(){return r.usePathname}}),a.o(r,"useRouter")&&a.d(t,{useRouter:function(){return r.useRouter}}),a.o(r,"useSearchParams")&&a.d(t,{useSearchParams:function(){return r.useSearchParams}})},25870:(e,t,a)=>{Promise.resolve().then(a.bind(a,14861))},33946:(e,t,a)=>{"use strict";a.d(t,{M:()=>l,S:()=>o});var r=a(95155),n=a(12115),i=a(65034);let s=(0,n.createContext)(null);function l(){let e=(0,n.useContext)(s);return e||{show:e=>{var t;let a="".concat(null!=(t=e.title)?t:"").concat(e.description?": ".concat(e.description):"").trim();try{a&&window.alert(a)}catch(e){}}}}function o(e){let{children:t}=e,[a,l]=(0,n.useState)([]),[o,c]=(0,n.useState)(!1);(0,n.useEffect)(()=>c(!0),[]);let d=(0,n.useCallback)(e=>{var t,a,r;let n=Date.now()+Math.floor(1e3*Math.random()),i={id:n,title:null!=(t=e.title)?t:"",description:null!=(a=e.description)?a:"",variant:null!=(r=e.variant)?r:"info",durationMs:"number"==typeof e.durationMs?e.durationMs:3e3};l(e=>[...e,i]),i.durationMs&&i.durationMs>0&&setTimeout(()=>{l(e=>e.filter(e=>e.id!==n))},i.durationMs)},[]),u=(0,n.useMemo)(()=>({show:d}),[d]);return(0,r.jsxs)(s.Provider,{value:u,children:[t,o?(0,r.jsx)("div",{suppressHydrationWarning:!0,className:"pointer-events-none fixed bottom-4 right-4 z-50 flex w-[92vw] max-w-md flex-col-reverse gap-3 sm:w-auto",children:a.map(e=>(0,r.jsx)("div",{className:"pointer-events-auto",children:(0,r.jsx)(i.A,{variant:e.variant,title:e.title,description:e.description})},e.id))}):null]})}},52828:(e,t,a)=>{"use strict";a.d(t,{A:()=>l});var r=a(95155),n=a(12115),i=a(20063),s=a(96648);function l(e){let{children:t}=e,[a,l]=(0,n.useState)(!0),o=(0,i.useRouter)();return((0,n.useEffect)(()=>{(async()=>{try{let e=(0,s.getSupabaseBrowserClient)(),{data:t}=await e.auth.getUser(),a=null==t?void 0:t.user,r="ssabarisasthass@gmail.com".split(/[,\s;]+/).filter(Boolean);if(!(a&&(0===r.length||r.includes((a.email||"").toLowerCase()))))return void o.replace("/admin");l(!1)}catch(e){o.replace("/admin")}})()},[o]),a)?(0,r.jsx)("main",{className:"min-h-screen grid place-items-center",children:(0,r.jsx)("p",{className:"text-sm text-muted-foreground",children:"Verifying admin access…"})}):(0,r.jsx)(r.Fragment,{children:t})}},64269:(e,t,a)=>{"use strict";a.d(t,{cn:()=>i});var r=a(2821),n=a(75889);function i(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];return(0,n.QP)((0,r.$)(t))}},65034:(e,t,a)=>{"use strict";a.d(t,{A:()=>h});var r=a(95155),n=a(12115),i=a(24342),s=a(951),l=a(61362),o=a(65229),c=a(52056),d=a(23327),u=a(64269);let m={success:(0,r.jsx)(l.A,{className:"h-6 w-6"}),error:(0,r.jsx)(o.A,{className:"h-6 w-6"}),warning:(0,r.jsx)(c.A,{className:"h-6 w-6"}),info:(0,r.jsx)(d.A,{className:"h-6 w-6"})};function h(e){let{variant:t="success",title:a="Default Alert Title",description:l="This is a default description for the alert. You can customize this text by passing props."}=e,[c,d]=(0,n.useState)(!0);return(0,r.jsx)(i.N,{children:c&&(0,r.jsxs)(s.P.div,{initial:{opacity:0,scale:.95,y:-10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,y:-10},transition:{duration:.25},className:(0,u.cn)("relative w-full max-w-md mx-auto p-4 rounded-2xl shadow-lg border","bg-white text-black border-black/10"),role:"status","aria-live":"polite",children:[(0,r.jsx)("button",{onClick:()=>d(!1),className:"absolute top-3 right-3 rounded-full p-1 hover:bg-black/10 transition","aria-label":"Dismiss alert",children:(0,r.jsx)(o.A,{className:"h-4 w-4"})}),(0,r.jsxs)("div",{className:"flex items-start gap-3",children:[(0,r.jsx)("div",{className:"flex-shrink-0 font-normal",children:m[t]}),(0,r.jsxs)("div",{className:"flex flex-col",children:[(0,r.jsx)("h4",{className:"text-base font-semibold",children:a}),l&&(0,r.jsx)("p",{className:"text-sm text-black opacity-80 mt-1",children:l})]})]})]})})}},96648:(e,t,a)=>{"use strict";a.r(t),a.d(t,{getSupabaseBrowserClient:()=>i});var r=a(85553);let n=globalThis;function i(){let e="https://lszcuaduebvabtifhbgp.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzemN1YWR1ZWJ2YWJ0aWZoYmdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzOTk5NTIsImV4cCI6MjA3NDk3NTk1Mn0.voMu1-4SKxSjZ1LK6x7shGKFI37YW8PtLFJKpPYvCAM";if(!e||!t)throw Error("Supabase env vars missing. Set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY.");let a=function(e,t){try{let t=new URL(e).host.split(".")[0];return"ayya.supabase.".concat(t,".auth.v1")}catch(e){return"ayya.supabase.".concat((t||"").slice(0,8),".auth.v1")}}(e,t);if(n.__supabaseClients[a])return n.__supabaseClients[a];let i=(0,r.UU)(e,t,{auth:{persistSession:!0,autoRefreshToken:!0,flowType:"pkce",detectSessionInUrl:!0,storageKey:a},global:{headers:{"x-ayya-client":"web"}},realtime:{params:{eventsPerSecond:2}}});return n.__supabaseClients[a]=i,i}null!=n.__supabaseClients||(n.__supabaseClients={})}},e=>{e.O(0,[1029,5553,951,4909,2090,8441,1255,7358],()=>e(e.s=25870)),_N_E=e.O()}]);